name: Termux Build All (aarch64 only, resumable)

on:
  workflow_dispatch:  # manual trigger only

jobs:
  build:
    name: Build all Termux packages (aarch64)
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/termux/package-builder:latest

    steps:
      # 1ï¸âƒ£ Checkout your repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Restore previous build progress (optional resume)
      - name: Restore build progress
        uses: actions/download-artifact@v4
        with:
          name: build-progress
          path: /home/builder/.termux-build/_buildall-aarch64
        continue-on-error: true

      # 3ï¸âƒ£ Prepare build environment
      - name: Prepare directories
        run: |
          mkdir -p /home/builder/.termux-build/output
          mkdir -p /tmp/artifacts
          mkdir -p /tmp/build-progress
          echo "âœ… Environment ready for aarch64"

      # 4ï¸âƒ£ Move repo into Termux build path
      - name: Move repository
        run: |
          mkdir -p /home/builder/termux-packages
          cp -r . /home/builder/termux-packages/
          echo "âœ… Repository copied to /home/builder/termux-packages"

      # 5ï¸âƒ£ Run build-all.sh
      - name: Run build-all.sh
        run: |
          cd /home/builder/termux-packages
          chmod +x ./build-all.sh
          ./build-all.sh -a aarch64 || true

      # 6ï¸âƒ£ Collect built .deb packages
      - name: Collect built packages
        if: always()
        run: |
          mkdir -p /tmp/artifacts
          find /home/builder/.termux-build/output -type f -name "*.deb" -exec cp {} /tmp/artifacts/ \; || true

      # 7ï¸âƒ£ Save build progress for resume
      - name: Save build progress
        if: always()
        run: |
          mkdir -p /tmp/build-progress
          cp -r /home/builder/.termux-build/_buildall-aarch64 /tmp/build-progress/ || true

      # 8ï¸âƒ£ Upload artifacts
      - name: Upload .deb artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: termux-debs-aarch64
          path: /tmp/artifacts
          retention-days: 7

      # 9ï¸âƒ£ Upload build progress
      - name: Upload build progress
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-progress
          path: /tmp/build-progress
          retention-days: 7

      # ðŸ”Ÿ Add a clean summary to GitHub UI
      - name: Display build summary
        if: always()
        run: |
          SUMMARY_FILE="/home/builder/.termux-build/_buildall-aarch64/failed_packages.txt"
          echo "### Build Summary ðŸ§±" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -s "$SUMMARY_FILE" ]; then
            echo "âŒ Some packages failed to build:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat "$SUMMARY_FILE" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… All packages built successfully!" >> $GITHUB_STEP_SUMMARY
          fi
