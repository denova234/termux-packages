name: Build Termux Packages

on:  
  workflow_dispatch:

env:
  TERMUX_DOCKER_USE_SUDO: ""

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Make scripts executable
        run: chmod +x scripts/run-docker.sh build-package.sh
      
      - name: Build all packages with robust error handling
        run: |
          mkdir -p debs
          mkdir -p build-logs
          
          # Get ALL package directories
          find packages -name "build.sh" -type f | sed 's|/build.sh||' > all_packages.txt
          find x11-packages -name "build.sh" -type f | sed 's|/build.sh||' >> all_packages.txt 2>/dev/null || true
          find root-packages -name "build.sh" -type f | sed 's|/build.sh||' >> all_packages.txt 2>/dev/null || true
          
          total_packages=$(cat all_packages.txt | wc -l)
          echo "Found $total_packages packages to build"
          
          # Initialize log files
          echo "BUILD STARTED: $(date)" > build-logs/successful_packages.txt
          echo "BUILD STARTED: $(date)" > build-logs/failed_packages.txt
          echo "BUILD STARTED: $(date)" > build-logs/skipped_packages.txt
          
          successful_count=0
          failed_count=0
          skipped_count=0
          processed_count=0
          
          # Build each package independently - NO set -e in this subshell
          (
          while read pkg_dir; do
            processed_count=$((processed_count + 1))
            pkg_name=$(basename "$pkg_dir")
            echo "=== Building $pkg_name ($processed_count/$total_packages) ==="
            
            # Check if package was already built
            if find debs -name "${pkg_name}_*.deb" | grep -q .; then
              echo "ğŸ“¦ $pkg_name already built, skipping"
              echo "$pkg_name" >> build-logs/skipped_packages.txt
              skipped_count=$((skipped_count + 1))
              continue
            fi
            
            # Build the package with timestamp - continue even if it fails
            start_time=$(date +%s)
            if ./scripts/run-docker.sh ./build-package.sh -a aarch64 -i -o debs/ "$pkg_dir" 2>&1 | tee "build-logs/${pkg_name}.log"; then
              end_time=$(date +%s)
              build_time=$((end_time - start_time))
              echo "âœ… $pkg_name - SUCCESS (${build_time}s)"
              echo "$pkg_name - ${build_time}s" >> build-logs/successful_packages.txt
              successful_count=$((successful_count + 1))
            else
              end_time=$(date +%s)
              build_time=$((end_time - start_time))
              echo "âŒ $pkg_name - FAILED (${build_time}s)"
              echo "$pkg_name - ${build_time}s" >> build-logs/failed_packages.txt
              failed_count=$((failed_count + 1))
            fi
            
            # Progress update every 10 packages
            if [ $((processed_count % 10)) -eq 0 ]; then
              echo "ğŸ“Š Progress: $processed_count/$total_packages packages processed"
              echo "âœ… Successful so far: $successful_count"
              echo "âŒ Failed so far: $failed_count"
              echo "ğŸ“¦ Skipped so far: $skipped_count"
            fi
            
          done < all_packages.txt
          
          # Final summary
          echo "BUILD COMPLETED: $(date)" >> build-logs/successful_packages.txt
          echo "BUILD COMPLETED: $(date)" >> build-logs/failed_packages.txt
          echo "BUILD COMPLETED: $(date)" >> build-logs/skipped_packages.txt
          
          echo "=== BUILD SUMMARY ==="
          echo "âœ… Successful: $successful_count packages"
          echo "âŒ Failed: $failed_count packages" 
          echo "ğŸ“¦ Skipped (already built): $skipped_count packages"
          echo "ğŸ“Š Total processed: $processed_count packages"
          echo "ğŸ“‹ Expected total: $total_packages packages"
          )
      
      - name: Generate detailed report
        if: always()
        run: |
          echo "ğŸ“‹ DETAILED BUILD REPORT"
          echo "========================"
          echo ""
          echo "SUCCESSFUL PACKAGES:"
          cat build-logs/successful_packages.txt | grep -E '^[a-zA-Z0-9]' | sort | head -20 || echo "  None"
          echo ""
          echo "FAILED PACKAGES:"
          cat build-logs/failed_packages.txt | grep -E '^[a-zA-Z0-9]' | sort | head -20 || echo "  None"
          echo ""
          echo "SKIPPED PACKAGES:"
          cat build-logs/skipped_packages.txt | grep -E '^[a-zA-Z0-9]' | sort | head -20 || echo "  None"
          echo ""
          echo "BUILD STATISTICS:"
          echo "Total .deb files built: $(find debs -name "*.deb" 2>/dev/null | wc -l)"
          echo "Total size: $(du -sh debs/ 2>/dev/null | cut -f1 || echo "0")"
          echo ""
          echo "First 10 built packages:"
          ls debs/*.deb 2>/dev/null | head -10 || echo "  No packages built"
      
      - name: Upload built packages
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: termux-packages
          path: debs/
      
      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: build-logs/
      
      - name: Final status
        if: always()
        run: |
          echo "ğŸ‰ Build process completed!"
          success_count=$(find debs -name "*.deb" 2>/dev/null | wc -l)
          echo "ğŸ“¦ Final count: $success_count .deb packages built"
          if [ $success_count -eq 0 ]; then
            echo "âš ï¸  No packages were built. Check the logs for errors."
          else
            echo "âœ… Successfully built $success_count packages"
          fi
